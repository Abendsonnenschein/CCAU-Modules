// ==UserScript==
// @name        CCAU - Modules Section
// @namespace   CCAU Suite
// @description Automate course copies
// @match       https://*.instructure.com/courses/*/modules
// @version     0.2.4
// @author      Abendsonnenschein
// @icon        https://du11hjcvx0uqb.cloudfront.net/br/dist/images/favicon-e10d657a73.ico
// @grant       none
// @license     AGPL-3.-or-later
// ==/UserScript==
(()=>{function h(e,t,n,r){let o=document.querySelector(r),c=`<a class="btn" tabindex="0" id="${t}">${e}</a>`;o?.insertAdjacentHTML("afterbegin",c),o?.insertAdjacentHTML("afterbegin","&nbsp;"),document.querySelector(`#${t}`)?.addEventListener("click",n,!1)}function b(e){document.querySelector(e)?.click()}function i(e,t){let n=e;return t.forEach(r=>{let o=n?.children,c=o.length,s=r>=0?r:c-1;c>s&&(n=o[s])}),n}function p(e,t){return m().findIndex((n,r)=>r>=t&&n.title.toLowerCase()===e.toLowerCase())}function x(e){let t=e.toLowerCase(),n=/^(week|module|unit) \d{1,2}$/,r=/^(week|module|unit) \d{1,2}:/;return t==="start here"?"START HERE":n.test(t)?t.replace(t.split(" ")[0],"Week"):r.test(t)?t.split(":")[0].replace(t.split(" ")[0],"Week"):null}function u(e){console.log("[CCAU] "+e)}function m(){let e=".collapse_module_link";return Array.from(document.querySelectorAll(e))}function w(){let e=window.confirm;return window.confirm=function(){return!0},e}function S(e){window.confirm=e}function g(e,t){let n=document.querySelectorAll(".ig-row"),r=n.length;for(let o=0;o<r;o++){let c=n[o],s=i(c,[2,0]),d=i(c,e),l=s?.innerText||"";/^\*[a-z]{3,12} \d{1,2} - [a-z]{0,12} ?\d{1,2}\*$/.test(l.toLowerCase())&&(d?.click(),t(l))}}function y(e){u(`Removing date header: ${e}`);let t=document.querySelectorAll(".ui-kyle-menu"),n=Array.from(t),r=n.length;for(let o=0;o<r;o++){if(n[o].getAttribute("aria-hidden")!=="false")continue;let c=n[o],s=c.children.length;i(c,[s-1,0])?.click()}}function C(){let e=w();g([3,2,1,-1,0],y),S(e)}function _(){let t=Date.now(),n=Number(localStorage.getItem("ccau-updated"))??0,r="https://raw.githubusercontent.com/Abendsonnenschein/CCAU-Modules/main/dates.json";if(t-n<6048e5){u("To force an update, clear localStorage and refresh the page.");return}fetch(r).then(o=>o.json()).then(o=>{localStorage.setItem("ccau-dates",JSON.stringify(o)),localStorage.setItem("ccau-updated",t.toString())})}function B(e){switch(e){case 1:return"Spring";case 2:return"Summer";case 3:return"Fall";default:return"Winter"}}function k(){_();let e=localStorage.getItem("ccau-dates")??"{}",t=JSON.parse(e),r=prompt(`Please enter the term for which you would like to add dates.
    Valid terms are 1, 1B, 2, 2B, 3, 3B.
    1 = Spring, 2 = Summer, 3 = Fall`,"")??"";if(/^[123]B?$/.exec(r)===null)return u("Invalid term entered."),{};let o=parseInt(r[0],10),c=r.length===2,s=t[B(o)],d=c?8:0,l={};if(!s)return u("No dates found for this semester."),{};for(let a=0;a<s.length;a++)l[`Week ${a+1}`]=s[d+a];return l}function D(){let e="#add_module_item_select",n=document.querySelector(e);Array.from(n.options)?.forEach(o=>o.value="context_module_sub_header")}function L(){g([3,1,0],e=>{u(`Publishing ${e}`)})}function v(e,t,n){let r=m(),o=p(e,0),c=r[o].parentElement,s=i(c,[5,0,t]);s?.getAttribute("aria-label")?.startsWith(n)&&s?.click()}function I(e,t){let r=document.querySelector(e);r.value=t}function T(){C(),D();let e=k(),t=m(),n=p("START HERE",1);n===-1&&(u("Course not detected as a copy, updating all modules."),n=t.length);for(let r=0;r<n;r++){let o=t[r].title,c=x(o);if(!c){u(`${o} has an invalid name.`);continue}if(!e[c]){u(`No date found for ${c}`);continue}v(o,2,"Add Content"),I("#sub_header_title",e[c]),b(".add_item_button")}setTimeout(L,1500)}function A(){h("Add Dates","ccau-dates",T,".header-bar-right__buttons")}A();})();
